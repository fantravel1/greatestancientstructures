---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/global/Header.astro';
import Footer from '../components/global/Footer.astro';
import MobileNav from '../components/global/MobileNav.astro';
import structures from '../data/structures.json';
---

<BaseLayout
  title="Interactive World Map"
  description="Explore ancient structures across the globe with our interactive map. Filter by category, region, and age."
>
  <Header slot="header" />

  <section class="min-h-screen pt-20 pb-24">
    <div
      x-data="{
        filter: 'all',
        selected: null,
        structures: [],
        categories: ['all', 'megalithic', 'rock-cut', 'impossible', 'disputed'],
        get filteredStructures() {
          if (this.filter === 'all') return this.structures;
          return this.structures.filter(s => s.category === this.filter);
        },
        selectStructure(id) {
          this.selected = this.structures.find(s => s.id === id) || null;
        },
        latLngToXY(lat, lng) {
          // Simple equirectangular projection
          const x = ((lng + 180) / 360) * 100;
          const y = ((90 - lat) / 180) * 100;
          return { x, y };
        }
      }"
      x-init="structures = JSON.parse(document.getElementById('map-data').textContent)"
      class="h-full"
    >
      <!-- Header -->
      <div class="container-custom py-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
          <div>
            <h1 class="text-display-sm font-display font-bold text-stone-100">
              World <span class="text-gradient">Map</span>
            </h1>
            <p class="text-stone-400 mt-1">Explore ancient structures across the globe</p>
          </div>

          <!-- Filters -->
          <div class="flex flex-wrap gap-2">
            <template x-for="cat in categories" :key="cat">
              <button
                @click="filter = cat"
                :class="filter === cat ? 'bg-gold-400 text-obsidian-950' : 'bg-obsidian-800 text-stone-300 hover:bg-obsidian-700'"
                class="px-4 py-2 rounded-lg text-sm font-medium capitalize transition-all"
                x-text="cat"
              ></button>
            </template>
          </div>
        </div>
      </div>

      <!-- Map Container -->
      <div class="container-custom">
        <div class="relative bg-obsidian-900 rounded-2xl border border-obsidian-800 overflow-hidden" style="padding-bottom: 50%;">
          <!-- World Map SVG Background -->
          <svg
            viewBox="0 0 100 50"
            class="absolute inset-0 w-full h-full"
            preserveAspectRatio="xMidYMid slice"
          >
            <!-- Simple world outline -->
            <rect width="100" height="50" fill="#18181b"/>

            <!-- Grid lines -->
            <g stroke="#27272a" stroke-width="0.1">
              <line x1="0" y1="25" x2="100" y2="25"/>
              <line x1="50" y1="0" x2="50" y2="50"/>
              <line x1="0" y1="12.5" x2="100" y2="12.5" stroke-dasharray="0.5"/>
              <line x1="0" y1="37.5" x2="100" y2="37.5" stroke-dasharray="0.5"/>
              <line x1="25" y1="0" x2="25" y2="50" stroke-dasharray="0.5"/>
              <line x1="75" y1="0" x2="75" y2="50" stroke-dasharray="0.5"/>
            </g>

            <!-- Simplified continent shapes -->
            <g fill="#27272a" opacity="0.5">
              <!-- North America -->
              <path d="M10,10 Q15,8 20,12 L25,15 Q22,20 18,22 L12,20 Q8,15 10,10Z"/>
              <!-- South America -->
              <path d="M22,25 L28,28 Q30,35 25,42 L20,40 Q18,32 22,25Z"/>
              <!-- Europe -->
              <path d="M45,12 Q52,10 55,14 L53,18 Q48,17 45,12Z"/>
              <!-- Africa -->
              <path d="M45,20 Q52,18 56,25 L54,35 Q48,38 44,32 L45,20Z"/>
              <!-- Asia -->
              <path d="M55,8 Q70,6 80,12 L85,20 Q80,28 70,25 L60,20 Q55,15 55,8Z"/>
              <!-- Australia -->
              <path d="M78,32 Q85,30 88,35 L86,40 Q80,42 78,38 L78,32Z"/>
            </g>

            <!-- Structure markers -->
            <template x-for="structure in filteredStructures" :key="structure.id">
              <g
                :transform="`translate(${latLngToXY(structure.coordinates[0], structure.coordinates[1]).x}, ${latLngToXY(structure.coordinates[0], structure.coordinates[1]).y})`"
                @click="selectStructure(structure.id)"
                class="cursor-pointer"
              >
                <!-- Pulse animation -->
                <circle
                  r="1.5"
                  :fill="structure.category === 'megalithic' ? '#facc15' : structure.category === 'rock-cut' ? '#a78bfa' : structure.category === 'impossible' ? '#facc15' : '#78716c'"
                  opacity="0.3"
                  class="animate-ping"
                />
                <!-- Main dot -->
                <circle
                  r="0.8"
                  :fill="structure.category === 'megalithic' ? '#facc15' : structure.category === 'rock-cut' ? '#a78bfa' : structure.category === 'impossible' ? '#facc15' : '#78716c'"
                  stroke="#09090b"
                  stroke-width="0.2"
                />
              </g>
            </template>
          </svg>

          <!-- Legend -->
          <div class="absolute bottom-4 left-4 p-3 rounded-xl bg-obsidian-950/90 backdrop-blur-sm border border-obsidian-800 text-xs">
            <div class="flex flex-wrap gap-4">
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-gold-400"></span>
                <span class="text-stone-400">Megalithic / Impossible</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-mystic-400"></span>
                <span class="text-stone-400">Rock-Cut</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-stone-500"></span>
                <span class="text-stone-400">Disputed</span>
              </div>
            </div>
          </div>

          <!-- Results count -->
          <div class="absolute top-4 left-4 px-3 py-2 rounded-lg bg-obsidian-950/90 backdrop-blur-sm border border-obsidian-800">
            <span class="text-sm text-stone-400">
              Showing <span x-text="filteredStructures.length" class="text-gold-400 font-bold"></span> structures
            </span>
          </div>
        </div>

        <!-- Selected Structure Panel -->
        <div
          x-show="selected"
          x-transition
          class="mt-6"
        >
          <div class="card p-6 md:flex gap-6">
            <template x-if="selected">
              <img
                :src="selected.heroImage"
                :alt="selected.name"
                class="w-full md:w-48 h-32 md:h-auto object-cover rounded-xl mb-4 md:mb-0"
              />
            </template>
            <div class="flex-1" x-show="selected">
              <template x-if="selected">
                <div>
                  <div class="flex items-center gap-3 mb-2">
                    <span
                      :class="{
                        'badge-gold': selected.category === 'megalithic' || selected.category === 'impossible',
                        'badge-mystic': selected.category === 'rock-cut',
                        'badge-stone': selected.category === 'disputed'
                      }"
                      class="badge"
                      x-text="selected.category"
                    ></span>
                    <span class="text-sm text-stone-500" x-text="selected.country"></span>
                  </div>
                  <h2 class="text-2xl font-bold text-stone-100 mb-2" x-text="selected.name"></h2>
                  <p class="text-gold-400 mb-3" x-text="selected.tagline"></p>
                  <p class="text-stone-400 text-sm mb-4" x-text="selected.summary"></p>
                  <div class="flex flex-wrap gap-4 text-sm text-stone-500 mb-4">
                    <span x-text="selected.dates.age"></span>
                    <span x-show="selected.stats.largestStone" x-text="'Largest: ' + selected.stats.largestStone"></span>
                  </div>
                  <a
                    :href="`/structures/${selected.slug}`"
                    class="btn-primary inline-flex"
                  >
                    Explore Site
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                  </a>
                </div>
              </template>
            </div>
            <button
              @click="selected = null"
              class="absolute top-4 right-4 p-2 text-stone-500 hover:text-stone-300 transition-colors"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Structure List (below map) -->
        <div class="mt-8 grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <template x-for="structure in filteredStructures" :key="structure.id">
            <button
              @click="selectStructure(structure.id)"
              :class="selected?.id === structure.id ? 'border-gold-400 bg-obsidian-800' : 'border-obsidian-700 hover:border-obsidian-600'"
              class="p-4 rounded-xl border text-left transition-all"
            >
              <div class="flex items-center gap-3">
                <img
                  :src="structure.heroImage"
                  :alt="structure.name"
                  class="w-12 h-12 rounded-lg object-cover"
                />
                <div class="flex-1 min-w-0">
                  <h3 class="font-semibold text-stone-200 truncate" x-text="structure.name"></h3>
                  <p class="text-xs text-stone-500" x-text="structure.country"></p>
                </div>
              </div>
            </button>
          </template>
        </div>
      </div>

      <!-- Data -->
      <script type="application/json" id="map-data" set:html={JSON.stringify(structures)}></script>
    </div>
  </section>

  <Footer slot="footer" />
  <MobileNav />
</BaseLayout>
